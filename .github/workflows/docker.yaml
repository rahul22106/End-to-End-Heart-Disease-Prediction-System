name: Docker CI/CD Pipeline - Fixed

on:
  push:
    branches:
      - main
      - develop

env:
  DOCKER_IMAGE_NAME: end-to-end-heart-disease-prediction
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 3: Deploy to Render
  deploy-to-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://end-to-end-heart-disease-prediction-f3my.onrender.com
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Trigger Render Deployment
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{}'

      - name: Wait for Deployment
        run: |
          echo "Waiting for Render deployment to complete..."
          sleep 60

      - name: Verify Deployment
        run: |
          # Check if the service is responding
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            echo "Checking deployment status (attempt $((attempt+1))/$max_attempts)..."
            
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.RENDER_APP_URL }}" || echo "000")
            
            if [ "$response" = "200" ] || [ "$response" = "301" ] || [ "$response" = "302" ]; then
              echo "âœ… Deployment successful! Service is responding."
              exit 0
            fi
            
            echo "Service not ready yet (HTTP $response). Waiting 30 seconds..."
            sleep 30
            attempt=$((attempt+1))
          done
          
          echo "âš ï¸ Deployment verification timed out. Please check Render dashboard."
          exit 0
        continue-on-error: true

  # Job 4: Health Check
  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: deploy-to-render
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Run Health Checks
        run: |
          echo "Running health checks..."
          
          # Check if app is accessible
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.RENDER_APP_URL }}" || echo "000")
          
          if [ "$response" = "200" ] || [ "$response" = "301" ] || [ "$response" = "302" ]; then
            echo "âœ… Health check passed! App is accessible."
          else
            echo "âŒ Health check failed! HTTP Status: $response"
            exit 1
          fi

      - name: Test API Endpoints
        run: |
          echo "Testing application endpoints..."
          # Add specific endpoint tests here if needed
          echo "âœ… Endpoint tests completed"
        continue-on-error: true

  # Job 5: Notification
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-to-render, health-check]
    if: always()
    
    steps:
      - name: Set Deployment Status
        id: status
        run: |
          if [[ "${{ needs.build-and-push.result }}" == "failure" ]]; then
            echo "status=âŒ Build Failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.deploy-to-render.result }}" == "failure" ]]; then
            echo "status=âŒ Deployment Failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.health-check.result }}" == "failure" ]]; then
            echo "status=âš ï¸ Health Check Failed" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          else
            echo "status=âœ… Deployment Successful" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: custom
          custom_payload: |
            {
              "text": "End-to-End Heart Disease Prediction System Deployment",
              "attachments": [{
                "color": "${{ steps.status.outputs.color }}",
                "fields": [
                  {
                    "title": "Status",
                    "value": "${{ steps.status.outputs.status }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "Author",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "App URL",
                    "value": "${{ secrets.RENDER_APP_URL }}",
                    "short": false
                  }
                ]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Send Email Notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸš¨ CI/CD Pipeline Failed - End-to-End Heart Disease Prediction"
          body: |
            The CI/CD pipeline has failed for End-to-End Heart Disease Prediction System.
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
            
            Pipeline Results:
            - Build & Push: ${{ needs.build-and-push.result }}
            - Deploy: ${{ needs.deploy-to-render.result }}
            - Health Check: ${{ needs.health-check.result }}
            
            Please check the GitHub Actions logs for details:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <noreply@github.com>
        continue-on-error: true

      - name: Create GitHub Deployment Status
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.status.outputs.status }}';
            const state = status.includes('âœ…') ? 'success' : 'failure';
            
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: state,
              environment_url: '${{ secrets.RENDER_APP_URL }}',
              description: status
            });
        continue-on-error: true